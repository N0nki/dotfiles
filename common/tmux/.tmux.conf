# color
set -g default-terminal "screen-256color"
set-option -ga terminal-overrides ",xterm-256color:Tc"
set -g window-active-style "bg=#161821"
set -g window-style "bg=#262831"

# theme
## iceberg
set -g status-position top
set -g status-style "bg=#1e2132"

# modules
module_left_1="#h"
module_left_2="#S:#I.#P"

module_right_1="zoom #{?window_zoomed_flag,on,off}"
module_right_2="synchronize #{?pane_synchronized,on,off}"
module_right_3="%a %d %b"
module_right_4="%R %Z"

set -g status-left "#[fg=#282C34]#[bg=#6b7089] $module_left_1 #[fg=#c6c8d1]#[bg=#2f313d] $module_left_2 "
set -g status-left-style ""
set -g status-left-length 50

set -g status-right "#[fg=#e2a478,bg=#1e2132]#[fg=#282C34,bg=#e2a478] $module_right_1 #[fg=#e27878,bg=#e2a478]#[fg=#282C34,bg=#e27878] $module_right_2 #[fg=#6b7089,bg=#e27878]#[fg=#282C34,bg=#6b7089] $module_right_3  $module_right_4 "
set -g status-right-style ""
set -g status-right-length 100

# set -g window-status-style "fg=#6b7089"
set -g window-status-format " #[fg=#c6c8d1] #{?#{==:#W,fish},#{b:pane_current_path},#W}#F #[fg=#1e2132]"
set -g window-status-current-format " #[fg=#282C34]#[bg=#84a0c6] #{?#{==:#W,fish},#{b:pane_current_path},#W} #[fg=#84a0c6]#[bg=#1e2132]"
set -g window-status-current-style "bold"
set -g window-status-separator ""

set -g pane-active-border-style "fg=#6f9bdf,bold"
set -g pane-border-style "fg=#6b7089"

# settings
set -g history-limit 50000

# key bind
set -g prefix C-t

## Session

## Window
### move
bind -r C-h select-window -t :-
bind -r C-l select-window -t :+

### swap
bind -r C-a run "tmux swap-window -t -1 && tmux previous-window"
bind -r C-e run "tmux swap-window -t +1 && tmux next-window "

### split
bind v split-window -h
bind w split-window -v

### even split
bind V split-window -h \; select-layout even-horizontal
bind W split-window -v \; select-layout even-vertical

## Pane
### move
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

### resize
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

### open current pane in a new window
bind O break-pane

## copy mode
set-window-option -g mode-keys vi
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi Escape send-keys -X clear-selection
# select to end of line
bind -T copy-mode-vi E send-keys -X begin-selection \; send-keys -X end-of-line \; send-keys -X cursor-left

## toggle synchronize panes
bind b set-window-option synchronize-panes \; display "synchronize-panes #{?pane_synchronized,on,off}"

## AI coding agents side by side
### Horizontal layout (bottom): prefix + B
### 1. Split horizontally (create bottom pane)
### 2. Split bottom pane vertically (left: claude, right: codex)
### -c "#{pane_current_path}" keeps the same directory as the current pane
bind A split-window -v -l 16 -c "#{pane_current_path}" claude \; split-window -h -c "#{pane_current_path}" codex

### Vertical layout (right): prefix + Ctrl-a
### 1. Split vertically (create right pane)
### 2. Split right pane horizontally (top: claude, bottom: codex)
bind B split-window -h -l 80 -c "#{pane_current_path}" claude \; split-window -v -c "#{pane_current_path}" codex

## others

### toggle passthrough
bind-key p if-shell "tmux show-option -g allow-passthrough | grep -q on" \
  "set -g allow-passthrough off; display 'Passthrough: OFF'" \
  "set -g allow-passthrough all; display 'Passthrough: ON'"

### reload config
bind r source-file ~/.tmux.conf \; display "Reloaded!"

### on/off status bar
bind n set status on
bind f set status off

### popup Neovim with Fugitive (git status)
bind e display-popup -w 80% -h 80% -E -d '#{pane_current_path}' "NVIM_MINIMAL=1 nvim -c '0Git'"

### fzf-git integration in popup (using custom key table)
#### Ctrl-g to enter fzf-git mode
bind -n C-g switch-client -T fzf-git

#### fzf-git key bindings (results copied to clipboard)
bind -T fzf-git C-b display-popup -w 90% -h 70% -E -d '#{pane_current_path}' "bash ~/dotfiles/common/tmux/fzf-git-popup.sh branches"
bind -T fzf-git C-h display-popup -w 90% -h 70% -E -d '#{pane_current_path}' "bash ~/dotfiles/common/tmux/fzf-git-popup.sh hashes"
bind -T fzf-git C-t display-popup -w 90% -h 70% -E -d '#{pane_current_path}' "bash ~/dotfiles/common/tmux/fzf-git-popup.sh tags"
bind -T fzf-git C-f display-popup -w 90% -h 70% -E -d '#{pane_current_path}' "bash ~/dotfiles/common/tmux/fzf-git-popup.sh files"
bind -T fzf-git C-r display-popup -w 90% -h 70% -E -d '#{pane_current_path}' "bash ~/dotfiles/common/tmux/fzf-git-popup.sh remotes"
bind -T fzf-git C-s display-popup -w 90% -h 70% -E -d '#{pane_current_path}' "bash ~/dotfiles/common/tmux/fzf-git-popup.sh stashes"
bind -T fzf-git C-l display-popup -w 90% -h 70% -E -d '#{pane_current_path}' "bash ~/dotfiles/common/tmux/fzf-git-popup.sh lreflogs"
bind -T fzf-git C-w display-popup -w 90% -h 70% -E -d '#{pane_current_path}' "bash ~/dotfiles/common/tmux/fzf-git-popup.sh worktrees"

# plugins
## prefix + I - install plugin
## prefix + U - update plugin
## prefix + alt + u - uninstall plugin not on the list
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'

## save and restore session
## prefix + Ctrl-s - save
## prefix + Ctrl-r - restore
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @resurrect-strategy-nvim 'session'
## continuous saving of tmux environment
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'

## Lightweight tmux utilities for manipulating tmux sessions
## prefix + Shift-c - create a new session
## prefix + Shift-x - kill current session
set -g @plugin 'tmux-plugins/tmux-sessionist'
set -g @sessionist-goto ''  # disable prefix + g (use custom popup instead)

## logging, screen capture
## prefix + shift + p - toggle logging current pane
## prefix + alt + p - screen capture
## prefix + alt + shift + p - save complete history
set -g @plugin 'tmux-plugins/tmux-logging'

## copy/paste mmany matched patterns(e.g. file path, ip address...)
## prefix + space - copy matched patterns
## prefix + ] - paste matched patterns
set -g @plugin 'fcsonline/tmux-thumbs'

## tmux nerd font
set -g @plugin 'joshmedeski/tmux-nerd-font-window-name'

## tmux-fzf - fzf integration for tmux management
## prefix + F - open tmux-fzf menu
set -g @plugin 'sainnhe/tmux-fzf'

## tmux-open - open highlighted selection in browser/editor
## In copy mode:
##   o       - open with default program
##   Ctrl-o  - open with $EDITOR
##   S       - search selection in Google
set -g @plugin 'tmux-plugins/tmux-open'
set -g @open-S 'https://www.google.com/search?q='

## tmux-fzf-url - open URLs from terminal with fzf
## prefix + U - select and open URL in browser
set -g @plugin 'wfxr/tmux-fzf-url'
set -g @fzf-url-bind 'U'
set -g @fzf-url-history-limit '2000'

## tmux-op-secure (custom secure 1Password integration)
## prefix + u - search and select password (no token files)
## prefix + o - search and select OTP/2FA code
set -g @plugin 'N0nki/tmux-op-secure'
set -g @1password-copy-to-clipboard 'on'
set -g @1password-auto-clear-seconds '30'
set -g @1password-otp-auto-clear-seconds '10'
set -g @1password-categories 'Login'
# Optional: enable cache (stores only metadata, no passwords)
set -g @1password-use-cache 'on'
set -g @1password-cache-age '0'

# tmux-pet
set -g @plugin 'nyuyuyu/tmux-pet'
set -g @pet-new-pane-key 'C-p'
# set -g @pet-vertical-split-pane-key 'C-s'
set -g @pet-path 'pet'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'

# Post-TPM bindings (override plugin bindings)
## restore default 'o' (other-end) and unbind Ctrl-o in copy mode (overrides tmux-open)
bind -T copy-mode-vi o send-keys -X other-end
unbind -T copy-mode-vi C-o
## popup shell (overrides tmux-sessionist's goto session)
bind g display-popup -w 90% -h 70% -E -d '#{pane_current_path}' "keifu"
